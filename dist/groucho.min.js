/*! Groucho - v0.1.0 - 2014-07-15
* https://github.com/tableau-mkt/groucho
* Copyright (c) 2014 Josh Lind; Licensed MIT */

!function(a){window.groucho=window.groucho||{},groucho.config=groucho.config||{taxonomyProperty:"tags",trackExtent:25,trackProperties:["title","type","tags"]},groucho.userDeferred=groucho.userDeferred||a.Deferred(),groucho.favoriteTerms=!1,a(document).ready(function(){groucho.trackOrigins(),groucho.trackHit()}),groucho.trackOrigins=function(){var b=(new Date).getTime(),c={timestamp:b,url:window.location.href};a.jStorage.get("user.session_origin")&&document.referrer||a.jStorage.set("user.session_origin",JSON.stringify(c)),a.jStorage.get("user.origin")||(c.referrer=document.referrer,a.jStorage.set("user.origin",JSON.stringify(c))),groucho.userDeferred.resolve()},groucho.trackHit=function(){var a,b=new DataLayerHelper(dataLayer),c=groucho.config.trackProperties,d={url:window.location.href};if(typeof trackExtent!==!1&&"undefined"!=typeof dataLayer)for(a in c)"undefined"!=typeof b.get(c[a])&&(d[c[a]]=b.get(c[a]));groucho.createActivity("browsing",JSON.stringify(d))},groucho.createActivity=function(b,c){var d=new groucho.getActivities(b),e=(new Date).getTime(),f=0;if(a.jStorage.set("track."+b+"."+e,c),d.length>groucho.config.trackExtent){f=d.length-groucho.config.trackExtent;for(var g=0;f>=g;g++)a.jStorage.deleteKey(d[g]._key)}},groucho.getActivities=function(b){var c,d,e=a.jStorage.index(),f=[];for(d in e)b?0===e[d].indexOf("track."+b)&&(c=JSON.parse(a.jStorage.get(e[d])),c._key=e[d],f.push(c)):(c=JSON.parse(a.jStorage.get(e[d])),c._key=e[d],f.push(c));return f},groucho.getFavoriteTerms=function(a,b){function c(a,c){for(var e in g[c][h][a])j.hasOwnProperty(a)||(j[a]={}),j[a].hasOwnProperty(e)?j[a][e].count++:j[a][e]={name:g[c][h][a][e],count:1};b||d(a)}function d(a){var b=0;for(var c in j[a])j[a][c].count>=b?b=j[a][c].count:delete j[a][c]}function e(a){var b=[];for(var c in a)a[c].id=c,b.push(a[c]);return b}var f,g=groucho.getActivities("browsing"),h=groucho.config.taxonomyProperty,i=[],j={};if(b=b||!1,a=a||"*","undefined"!=typeof h){for(var k in g)if("undefined"==typeof i[g[k].url]&&g[k].hasOwnProperty(h))if(i[g[k].url]=!0,"*"===a)for(f in g[k][h])c(f,k);else g[k][h].hasOwnProperty(a)&&c(a,k);if("*"===a){for(f in j)j[f]=e(j[f]);b===!1&&(groucho.favoriteTerms=j)}else j=e(j[a])}return j}}(jQuery);