/*! Groucho - v0.1.0 - 2014-07-14
* https://github.com/tableau-mkt/groucho
* Copyright (c) 2014 Josh Lind; Licensed MIT */

!function(a){window.groucho=window.groucho||{},groucho.config=groucho.config||{taxonomyProperty:"tags",trackExtent:25,trackProperties:["title","type","tags"]},groucho.userDeferred=groucho.userDeferred||a.Deferred(),groucho.favoriteTerms=!1,a(document).ready(function(){groucho.trackOrigins(),groucho.trackHit()}),groucho.trackOrigins=function(){var b=(new Date).getTime(),c={timestamp:b,url:window.location.href};a.jStorage.get("user.session_origin")&&document.referrer||a.jStorage.set("user.session_origin",JSON.stringify(c)),a.jStorage.get("user.origin")||(c.referrer=document.referrer,a.jStorage.set("user.origin",JSON.stringify(c))),groucho.userDeferred.resolve()},groucho.trackHit=function(){var a,b=new DataLayerHelper(dataLayer),c=groucho.config.trackProperties,d={url:window.location.href};if(typeof trackExtent!==!1&&"undefined"!=typeof dataLayer)for(a in c)"undefined"!=typeof b.get(c[a])&&(d[c[a]]=b.get(c[a]));groucho.createActivity("browsing",JSON.stringify(d))},groucho.getFavoriteTerms=function(a,b){function c(a,b){for(var c in b)j.hasOwnProperty(a)||(j[a]={}),j[a].hasOwnProperty(c)?j[a][c].count++:j[a][c]={name:b[c],count:1}}var d,e=groucho.getActivities("browsing"),f=groucho.config.taxonomyProperty,g=!1,h={},i=[],j={};if(b=b||!1,a=a||"*","undefined"!=typeof f){for(var k in e)if("undefined"==typeof i[e[k].url]&&e[k].hasOwnProperty(f))if(i[e[k].url]=!0,"*"===a)for(d in e[k][f])c(d,e[k][f][d]);else e[k][f].hasOwnProperty(a)&&c(a,e[k][f][a]);if(b)g=j;else{for(d in j){var l=0;for(var m in j[d])j[d][m].count>l&&(l=j[d][m].count);for(var n in j[d])j[d][n].count===l&&(h.hasOwnProperty(d)||(h[d]={}),h[d][n]=j[d][n])}g=h}}return"*"===a&&b===!1&&(groucho.favoriteTerms=g),g},groucho.getActivities=function(b){var c=a.jStorage.index(),d={},e=0;if(b)for(e in c)0===c[e].indexOf("track."+b)&&(d[c[e]]=JSON.parse(a.jStorage.get(c[e])));else for(e in c)d[c[e]]=JSON.parse(a.jStorage.get(c[e]));return d},groucho.createActivity=function(b,c){var d=new groucho.Collection(groucho.getActivities(b)),e=d.keys(),f=(new Date).getTime(),g=0;if(a.jStorage.set("track."+b+"."+f,c),d.size()>groucho.config.trackExtent){g=d.size()-groucho.config.trackExtent;for(var h=0;g>=h;h++)a.jStorage.deleteKey(e[h])}},groucho.Collection=function(a){var b=null,c=null;return{keys:function(){if(null===b){b=[];for(var c in a)b.push(c)}return b.sort()},size:function(){return null==a?0:(null===c&&(c=this.keys().length),c)},get:function(){return a}}}}(jQuery);